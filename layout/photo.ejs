<script src="js/html2canvas.js"></script>
<section class="pjax-area">
    <%- include('_partial/single-photo.ejs') %>
        <script type="module">
            var imageBox = document.getElementById("imgbox"); // imageBox 是放置大图片的图框
            var descBox = $("#descbox");
            var descBox = $("#descbox");
            var nextBox = $("#nextbox");
            var copyBox = $("#copybox");
            var wrapper = $("#exif-wrapper");
            var exifParam = $("#exif-param");
            var exifMaker = $("#exif-maker");
            var exifDate = $("#exif-date");
            var exifLens = $("#exif-lens");
            var exifLogo = $("#exif-maker-logo");
            var exifAuthor = $("#exif-author");            
            var normalWrapper = $("#normal-wrapper");
            var normalData = $("#no-exif-data");
            const name = getParam('name');
            var imgLink = '<%- config.base_url %>' + '/' + name;
            // hide useless button
            $("#tools-wrapper").show();
            $("#copybox").hide();
            $("#nextbox").hide();
            $("#downloadbox").click(function () {
                var node = document.getElementById('all-pic');
                html2canvas(node, {
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                }).then(function (canvas) {              
                    simulateDownloadImageClick(canvas.toDataURL('image/png'),  name + '.png');
                });
            });
            const response = await fetch('photos.json');
            const all = await response.json();
            function searchPhoto() {
                if (name === "" || name == null) {
                    return;
                }
                imageBox.src = imgLink; //替换图片
                addBackUp(imageBox,"<%- config.backup_base_url %>/", name);
                for (const key of Object.keys(all)) {
                    var v = all[key];
                    if (v.path !== name || v.exif_data.length === 0) {
                        continue;
                    }

                    var imageFancy = imageBox.parentElement;
                    imageFancy.setAttribute("href", imgLink);
                    var fancyBoxImage = document.getElementsByClassName("fancybox__image")[0];
                    if (fancyBoxImage !== undefined) {
                        fancyBoxImage.src = imgLink;
                    }
                    $("#wrapper").show();
                    if (v.exif === "" || v.exif_data.length === 0) {
                        wrapper.hide();
                        normalWrapper.show();
                        normalData.text("Shot By " + "<%- config.author %>");
                        break;
                    } else {
                        wrapper.show();
                        normalWrapper.hide();
                    }
                    wrapperData(v, "<%- config.author %>");
                }
            }

            searchPhoto();
        </script>
</section>